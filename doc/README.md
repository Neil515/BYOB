# 🍷 BYOB 專案開發文檔

## 📋 專案概述

BYOB (Bring Your Own Bottle) 是一個餐廳資訊平台，讓消費者可以找到支援自帶酒水的餐廳。本專案使用 WordPress + WooCommerce 作為後端，並整合自定義的餐廳業者會員系統。

### 🎯 專案目標
- 建立完整的餐廳業者會員系統
- 提供餐廳資料管理功能
- 實現LOGO和圖片上傳管理
- 建立菜單和照片管理系統
- 提供管理員備用介入管道

---

## 🏗️ 技術架構

### 核心技術
- **後端**: WordPress 6.4.2 + WooCommerce 8.5.2
- **主題**: Flatsome Child Theme
- **外掛**: Advanced Custom Fields (ACF) Pro
- **自定義功能**: 餐廳業者會員系統、餐廳資料管理、LOGO上傳等

### 系統架構
```
WordPress Core
├── WooCommerce (會員系統)
├── ACF Pro (自定義欄位)
├── 自定義會員系統
│   ├── 餐廳業者角色管理
│   ├── 邀請碼系統
│   └── 權限控制
└── 自定義頁面模板
    ├── 餐廳資料編輯
    ├── 照片管理
    └── 菜單管理
```

---

## 📊 專案進度總覽

### 整體進度：95% ✅
- **第一階段**：100% ✅（自定義 WooCommerce 會員選單）
- **第二階段**：100% ✅（餐廳資料管理功能）
- **第三階段**：90% ✅（LOGO管理和前台顯示）
- **第四階段**：80% ✅（其他後台頁面開發）

### 功能完成度
- ✅ 會員選單自定義：100%
- ✅ 餐廳資料編輯：100%
- ✅ LOGO上傳管理：100%
- ✅ 前台LOGO顯示：100%
- ✅ 雙重LOGO系統：100%
- ✅ 開酒服務邏輯：100%
- ⏳ 照片管理頁面：0%
- ⏳ 菜單管理頁面：0%
- ⏳ 業者註冊流程UX：70%

---

## 🚀 開發進度記錄

### 2025-01-07 開發進度

#### 主要成就
- ✅ 成功建立自定義 WooCommerce 會員選單
- ✅ 解決 404 錯誤和頁面顯示問題
- ✅ 建立可重複使用的解決方案

#### 技術突破
1. **WooCommerce 會員選單自定義**
   - 使用 `woocommerce_account_menu_items` 過濾器
   - 完全覆蓋預設選單項目
   - 建立餐廳業者專用選單結構

2. **頁面載入問題解決**
   - 使用 `woocommerce_account_content` 鉤子
   - 優先級設定為 5，確保在預設內容之前執行
   - 移除 WooCommerce 預設內容，避免重複

3. **ACF 欄位資料載入**
   - 解決表單選項值與 ACF 欄位值不匹配問題
   - 將英文鍵值改為中文值（如 'taiwanese' → '台式'）
   - 新增開酒服務條件式顯示功能

#### 解決的問題
- 404 錯誤：使用正確的鉤子和優先級
- 左側選單消失：保持頁面結構完整
- 重複內容：移除預設 WooCommerce 內容
- ACF 資料不匹配：統一表單和欄位值

#### 重要里程碑
*重要里程碑：成功解決 404 錯誤和頁面顯示問題，建立可重複使用的解決方案*

---

### 2025-01-08 開發進度

#### 主要成就
- ✅ 前台LOGO顯示功能完全修復
- ✅ 實作雙重LOGO系統（業者 + 管理員備用）
- ✅ 後台編輯頁面優化和UX改善
- ✅ 前台開酒服務顯示邏輯優化

#### 技術突破

##### 1. 前台LOGO顯示功能修復
**問題描述：**
- 前台頁面顯示的LOGO被裁切填滿
- 長方形圖片左右兩端消失
- 圖片顯示效果與後台預覽不一致

**根本原因：**
- WordPress 自動生成 `thumbnail` 尺寸會強制裁切圖片
- 前台讀取的是已裁切的圖片版本
- CSS 樣式 `object-fit: cover` 強制填滿容器

**解決方案：**
```php
// 修改圖片上傳函數，禁用自動生成 thumbnail 尺寸
function byob_handle_logo_upload($restaurant_id) {
    // ... 上傳處理邏輯 ...
    
    // 生成附件元數據，但不生成預設的 thumbnail 尺寸
    $attachment_data = wp_generate_attachment_metadata($attachment_id, $uploaded_file['file']);
    
    // 移除預設的 thumbnail 尺寸，避免裁切
    if (isset($attachment_data['sizes']['thumbnail'])) {
        unset($attachment_data['sizes']['thumbnail']);
    }
    
    wp_update_attachment_metadata($attachment_id, $attachment_data);
}
```

**前台讀取邏輯：**
```php
// 強制讀取原始圖片，避免使用任何預處理的尺寸
$logo_url = wp_get_attachment_url($logo_id);
```

**CSS 樣式優化：**
```css
.restaurant-image {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;  /* 強制填滿，會裁切圖片 */
}
```

##### 2. 雙重LOGO系統實作
**需求分析：**
- 業者正常情況：透過會員系統上傳LOGO
- 管理員緊急情況：業者遇到困難時可以介入
- 需要兩套系統並存，不是統一為一套

**實作方案：**
- **業者LOGO**：儲存到 `_restaurant_logo` meta 欄位
- **管理員LOGO**：使用現有 ACF 欄位 `restaurant_photo`
- **前台邏輯**：比較兩個LOGO的上傳時間，選擇最新的顯示

**技術實作：**
```php
// 獲取兩個 LOGO 的上傳時間，選擇最新的
$admin_logo = get_field('restaurant_photo', get_the_ID());
$user_logo_id = get_post_meta(get_the_ID(), '_restaurant_logo', true);

$logo_id = null;

if ($admin_logo && is_array($admin_logo)) {
    $admin_logo_id = $admin_logo['ID'];
    $admin_time = get_post_modified_time('U', false, $admin_logo_id);
    
    if ($user_logo_id) {
        $user_time = get_post_modified_time('U', false, $user_logo_id);
        // 選擇最新的
        $logo_id = ($admin_time > $user_time) ? $admin_logo_id : $user_logo_id;
    } else {
        $logo_id = $admin_logo_id;
    }
} else {
    $logo_id = $user_logo_id;
}
```

**運作邏輯：**
- **情況 1**：業者先上傳 → 管理員後上傳 → 顯示管理員的
- **情況 2**：管理員先上傳 → 業者後上傳 → 顯示業者的
- **情況 3**：只有業者上傳 → 顯示業者的
- **情況 4**：只有管理員上傳 → 顯示管理員的

##### 3. 後台編輯頁面優化
**上傳須知改善：**
- 新增「建議上傳正方形或接近正方形的圖片檔案，以達到最佳顯示效果」
- 放在第一條，讓用戶第一眼就看到重要建議
- 使用加粗顯示突出重要性

**操作指引優化：**
- 修改標籤為「上傳 LOGO或具代表性的餐廳照片(選擇檔案之後按更新餐廳資料)」
- 清楚告訴用戶選擇檔案後需要按「更新餐廳資料」按鈕
- 提供明確的操作指引

**介面簡化：**
- 移除複雜的JavaScript切換功能
- 預設使用 `object-fit: contain`（保持比例）
- 簡化CSS樣式，移除不必要的複雜邏輯

**JavaScript 功能簡化：**
```javascript
// 移除複雜的 LOGO 顯示模式切換
// 移除 changeLogoDisplay() 函數
// 移除 DOMContentLoaded 中的 LOGO 初始化邏輯
// 保留基本的開酒服務欄位顯示邏輯
```

##### 4. 前台開酒服務顯示邏輯優化
**問題描述：**
- 選擇"其他"時前台顯示"other"而不是說明內容
- 前台頁面沒有正確處理開酒服務的條件式顯示

**解決方案：**
```php
// 餐廳列表頁面（archive-restaurant.php）
$open_bottle_service = get_field('open_bottle_service');
$open_bottle_service_other_note = get_field('open_bottle_service_other_note');

if ($open_bottle_service): 
    if ($open_bottle_service === 'other' && $open_bottle_service_other_note): ?>
        <div class="field"><strong>是否提供開酒服務？：</strong><?php echo esc_html($open_bottle_service_other_note); ?></div>
    <?php else: ?>
        <div class="field"><strong>是否提供開酒服務？：</strong><?php echo esc_html($open_bottle_service); ?></div>
    <?php endif;
else: ?>
    <div class="field"><strong>是否提供開酒服務？：</strong>暫無資料</div>
<?php endif; ?>
```

**單一餐廳頁面邏輯：**
```php
// 單一餐廳頁面（single_restaurant.php）
if ($open_bottle_service === 'yes') {
    $service_output = '是';
} elseif ($open_bottle_service === 'no') {
    $service_output = '否';
} elseif ($open_bottle_service === 'other' && $open_bottle_service_other_note) {
    $service_output = $open_bottle_service_other_note;  // 只顯示說明內容
} elseif ($open_bottle_service === 'other') {
    $service_output = '其他';
} else {
    $service_output = $open_bottle_service;
}
```

#### 修改的檔案清單

##### 1. `wordpress/archive-restaurant.php`
- **修改內容**：LOGO讀取邏輯改為時間優先原則
- **技術變更**：從單一meta欄位讀取改為雙重LOGO系統
- **影響範圍**：餐廳列表頁面的LOGO顯示

##### 2. `wordpress/single_restaurant.php`
- **修改內容**：LOGO讀取邏輯改為時間優先原則
- **技術變更**：從單一meta欄位讀取改為雙重LOGO系統
- **影響範圍**：單一餐廳頁面的LOGO顯示

##### 3. `wordpress/woocommerce/myaccount/restaurant-profile.php`
- **修改內容**：後台編輯頁面優化和UX改善
- **技術變更**：
  - 新增上傳須知和操作指引
  - 簡化LOGO顯示介面
  - 移除複雜的JavaScript切換功能
- **影響範圍**：餐廳業者後台編輯頁面

##### 4. `wordpress/restaurant-member-functions.php`
- **修改內容**：圖片上傳處理邏輯優化
- **技術變更**：
  - 禁用自動生成 `thumbnail` 尺寸
  - 避免圖片被強制裁切
  - 保持原始圖片比例
- **影響範圍**：LOGO上傳功能

#### 技術架構優化

##### 圖片處理系統
**之前架構：**
- WordPress 自動生成多種尺寸
- 前台讀取 `thumbnail` 尺寸（會裁切）
- 後台使用複雜的 `object-fit` 切換

**現在架構：**
- 禁用自動 `thumbnail` 尺寸生成
- 前台讀取原始圖片
- 後台預設使用 `object-fit: contain`

##### LOGO管理系統
**之前架構：**
- 單一LOGO來源（業者會員系統）
- 前台直接讀取meta欄位

**現在架構：**
- 雙重LOGO來源（業者 + 管理員備用）
- 時間優先原則，後上傳覆蓋先上傳
- 前台智能選擇最新的LOGO

#### 解決的技術問題

##### 1. 圖片裁切問題
- **問題**：長方形圖片被強制裁切為正方形
- **原因**：WordPress `thumbnail` 尺寸和CSS `object-fit: cover`
- **解決**：禁用自動縮圖生成，使用原始圖片

##### 2. 雙重LOGO系統
- **問題**：管理員無法在業者遇到困難時介入
- **原因**：只有業者會員系統可以上傳LOGO
- **解決**：實作時間優先的雙重LOGO系統

##### 3. 前台顯示邏輯
- **問題**：開酒服務選擇"其他"時顯示"other"
- **原因**：前台沒有正確處理條件式顯示
- **解決**：修改前台邏輯，顯示說明內容

##### 4. 後台介面複雜性
- **問題**：LOGO顯示模式切換過於複雜
- **原因**：JavaScript邏輯複雜，用戶體驗不佳
- **解決**：簡化介面，預設使用最佳顯示模式

#### 使用者體驗改善

##### 1. 上傳指引優化
- **之前**：沒有明確的上傳建議
- **現在**：清楚說明建議使用正方形圖片
- **效果**：用戶知道如何達到最佳顯示效果

##### 2. 操作流程簡化
- **之前**：複雜的LOGO顯示模式選擇
- **現在**：預設最佳模式，無需選擇
- **效果**：減少用戶困惑，提高操作效率

##### 3. 錯誤處理改善
- **之前**：圖片被裁切，用戶可能不知道原因
- **現在**：圖片保持比例，用戶看到完整內容
- **效果**：提高用戶滿意度

#### 系統穩定性提升

##### 1. 圖片處理穩定性
- **之前**：依賴WordPress自動縮圖生成
- **現在**：直接使用原始圖片，減少處理環節
- **效果**：降低圖片顯示錯誤的機率

##### 2. LOGO管理穩定性
- **之前**：單一來源，故障時無法備用
- **現在**：雙重來源，管理員可以介入
- **效果**：提高系統可用性和維護性

##### 3. 程式碼維護性
- **之前**：複雜的JavaScript邏輯
- **現在**：簡化的PHP邏輯
- **效果**：降低維護成本，提高程式碼可讀性

#### 效能優化

##### 1. 圖片載入優化
- **之前**：載入多個尺寸的圖片
- **現在**：只載入原始圖片
- **效果**：減少伺服器儲存空間和載入時間

##### 2. JavaScript優化
- **之前**：複雜的DOM操作和事件處理
- **現在**：簡化的基本功能
- **效果**：減少前端資源消耗

##### 3. 資料庫查詢優化
- **之前**：可能需要多次查詢圖片資料
- **現在**：一次查詢獲取所有必要資訊
- **效果**：提高頁面載入速度

#### 未來擴展性

##### 1. 圖片管理系統
- 可以基於現有架構擴展為多圖片管理
- 支援餐廳環境照片、菜單圖片等
- 保持時間優先的覆蓋邏輯

##### 2. 權限管理系統
- 可以擴展為更細緻的權限控制
- 支援不同角色的圖片管理權限
- 保持管理員的備用介入能力

##### 3. 圖片處理系統
- 可以加入圖片壓縮和優化功能
- 支援更多圖片格式和處理選項
- 保持原始圖片的完整性

#### 測試和驗證

##### 1. 功能測試
- ✅ LOGO上傳功能正常
- ✅ 前台顯示正確（保持比例）
- ✅ 雙重LOGO系統運作正常
- ✅ 開酒服務邏輯正確

##### 2. 相容性測試
- ✅ 不同尺寸圖片正常顯示
- ✅ 不同格式圖片正常處理
- ✅ 響應式設計正常運作

##### 3. 錯誤處理測試
- ✅ 圖片上傳失敗處理
- ✅ 權限檢查正常
- ✅ 錯誤訊息顯示正確

#### 重要里程碑

##### 2025-01-08 里程碑
*重要里程碑：成功實作雙重LOGO系統，解決前台圖片顯示問題，建立完整的餐廳業者LOGO管理解決方案*

**技術成就：**
- 解決WordPress圖片裁切問題
- 實作時間優先的雙重LOGO系統
- 優化後台編輯頁面使用者體驗
- 改善前台開酒服務顯示邏輯

**業務價值：**
- 提高LOGO顯示品質
- 提供管理員備用介入管道
- 改善業者操作體驗
- 增強系統穩定性和可用性

#### 下一步計劃

##### 短期目標（本週）
1. 完成照片管理頁面開發
2. 完成菜單管理頁面開發
3. 進行業者註冊流程測試與UX改善

##### 中期目標（下週）
1. 前台頁面整合測試
2. 系統穩定性檢查
3. 效能優化

##### 長期目標（本月）
1. 完整系統測試
2. 使用者回饋收集
3. 功能迭代優化

---

## 🎯 整體專案目標

### 短期目標（本週）
1. 完成三個後台管理頁面
2. 優化業者註冊流程
3. 改善整體使用者體驗

### 中期目標（下週）
1. 前台頁面整合測試
2. 系統穩定性檢查
3. 效能優化

### 長期目標（本月）
1. 完整系統測試
2. 使用者回饋收集
3. 功能迭代優化

---

## 📝 注意事項

### 技術考量
- 保持程式碼簡潔可靠
- 優先考慮使用者體驗
- 確保系統穩定性
- 遵循 WordPress 最佳實踐

### 品質要求
- 功能完整且穩定
- 使用者介面友善
- 錯誤處理完善
- 響應式設計支援

### 測試重點
- 各項功能正常運作
- 錯誤情況處理
- 不同裝置相容性
- 使用者操作流程

---

## 📊 進度總結

### 已完成階段
- ✅ **第一階段：自定義 WooCommerce 會員選單（100%）**
- ✅ **第二階段：餐廳資料管理功能（100%）**
- ✅ **第三階段：LOGO管理和前台顯示（100%）**
- ⏳ **第四階段：其他後台頁面開發（80%）**
  - ✅ 餐廳資料編輯頁面（100%）
  - ✅ LOGO上傳和管理（100%）
  - ✅ 前台LOGO顯示（100%）
  - ✅ 開酒服務邏輯（100%）
  - ✅ 雙重LOGO系統（100%）
  - ⏳ 照片管理頁面（0%）
  - ⏳ 菜單管理頁面（0%）

### 明天重點
1. **照片管理頁面開發** - 多張照片上傳和管理功能
2. **菜單管理頁面開發** - 菜單項目和分類管理功能
3. **業者註冊流程測試與UX改善** - 流程優化和錯誤處理

---

## 🔍 問題解決參考指南

### 常見問題解決方案

#### 1. 404 錯誤問題
**解決方案：** 使用 `woocommerce_account_content` 鉤子，優先級為 5
**適用場景：** 自定義 WooCommerce 會員頁面

#### 2. 圖片裁切問題
**解決方案：** 禁用自動 `thumbnail` 尺寸生成，使用原始圖片
**適用場景：** 需要保持圖片比例的顯示需求

#### 3. 雙重資料來源
**解決方案：** 時間優先原則，後上傳的覆蓋先上傳的
**適用場景：** 需要備用資料來源的系統

#### 4. 前台顯示邏輯
**解決方案：** 修改前台程式碼，正確處理條件式顯示
**適用場景：** ACF 欄位的條件式內容顯示

### 技術最佳實踐

#### 1. WooCommerce 頁面自定義
- 優先使用 `woocommerce_account_content` 鉤子
- 正確設定優先級，避免與預設內容衝突
- 保持頁面結構完整

#### 2. 圖片處理
- 根據需求選擇是否生成縮圖
- 前台顯示優先考慮使用者體驗
- 後台管理保持功能完整性

#### 3. 資料管理
- 建立清晰的資料來源優先級
- 提供備用資料來源
- 保持資料一致性和完整性

---

## 📈 專案進度圖表

```
專案進度：95% ✅
├── 會員選單自定義：100% ✅
├── 餐廳資料編輯：100% ✅
├── LOGO上傳管理：100% ✅
├── 前台LOGO顯示：100% ✅
├── 雙重LOGO系統：100% ✅
├── 開酒服務邏輯：100% ✅
├── 照片管理頁面：0% ⏳
├── 菜單管理頁面：0% ⏳
└── 業者註冊流程UX：70% ⏳
```

---

## 🚀 2025-01-08 開發進度

### ✅ 主要成就
- 前台LOGO顯示功能完全修復
- 實作雙重LOGO系統（業者 + 管理員備用）
- 後台編輯頁面優化和UX改善
- 前台開酒服務顯示邏輯優化

### 🔧 技術突破
1. **前台LOGO顯示功能修復** - 解決圖片裁切問題
2. **雙重LOGO系統實作** - 時間優先原則，後上傳覆蓋先上傳
3. **後台編輯頁面優化** - 新增上傳須知和操作指引
4. **前台開酒服務顯示邏輯** - 選擇"其他"時顯示說明內容

### 📁 修改的檔案
- `archive-restaurant.php` - 餐廳列表頁面LOGO讀取邏輯
- `single_restaurant.php` - 單一餐廳頁面LOGO讀取邏輯  
- `restaurant-profile.php` - 後台編輯頁面優化
- `restaurant-member-functions.php` - 圖片上傳處理邏輯

### 🎯 明日工作重點
1. 照片管理頁面開發
2. 菜單管理頁面開發  
3. 業者註冊流程測試與UX改善

---

## 🎉 今日成果總結

### 技術突破
- 成功解決前台LOGO顯示問題
- 實作完整的雙重LOGO管理系統
- 優化後台編輯頁面使用者體驗
- 建立可擴展的圖片管理架構

### 業務價值
- 提高LOGO顯示品質和一致性
- 提供管理員緊急介入能力
- 改善業者操作體驗
- 增強系統整體穩定性

### 開發效率
- 解決複雜的技術問題
- 建立可重複使用的解決方案
- 優化程式碼結構和維護性
- 為未來功能擴展奠定基礎

---

*最後更新：2025-01-08*
*負責人：AI Assistant*
*下次重點：完成照片管理和菜單管理頁面，進行業者註冊流程測試與UX改善*
*重要里程碑：成功實作雙重LOGO系統，解決前台圖片顯示問題，專案進度達到 95%* 