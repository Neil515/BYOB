# Google 表單資料對應問題詳細記錄
**日期：2025-08-04**  
**狀態：待解決**  
**優先級：高**

## 📋 問題概述

### 當前狀況
- ✅ Google 表單自動導入 WordPress 基本流程已建立
- ✅ WordPress REST API 端點正常運作
- ✅ Google Apps Script 程式碼已實作並可執行
- ✅ 觸發器設定完成，可自動處理表單提交
- ✅ 通知郵件系統正常運作
- ❌ **關鍵問題：ACF 欄位資料對應不完整**

### 問題描述
雖然系統已成功建立 WordPress 文章，但部分 ACF 欄位資料對應失敗，導致前端顯示「暫無資料」。

## 🔍 詳細問題分析

### 1. 完全對應失敗的欄位

| Google 表單欄位 | WordPress ACF 欄位 | 當前狀態 | 問題描述 |
|----------------|-------------------|----------|----------|
| 您的稱呼是？ | 聯絡人 | ❌ 空白 | 完全無資料對應 |
| 是否收開瓶費？ | 是否收開瓶費 | ❌ 暫無資料 | 完全無資料對應 |
| 開瓶費金額 / 其他：請說明 | 開瓶費說明 | ❌ 暫無資料 | 完全無資料對應 |
| 是否提供酒器設備？ | 提供酒器設備 | ❌ 暫無資料 | 完全無資料對應 |
| 是否提供開酒服務？ | 是否提供開酒服務？ | ❌ 暫無資料 | 完全無資料對應 |

### 2. 成功對應的欄位

| Google 表單欄位 | WordPress ACF 欄位 | 當前狀態 | 備註 |
|----------------|-------------------|----------|------|
| 餐廳名稱 | 文章標題 | ✅ 正常 | 直接對應成功 |
| 地址 | 地址 | ✅ 正常 | 包含地圖圖示 |
| 聯絡電話 | 餐廳聯絡電話 | ✅ 正常 | 包含電話圖示 |
| 餐廳類型 | 餐廳類型 | ✅ 正常 | 複選欄位處理正確 |
| 餐廳網站或訂位連結 | 官方網站/社群連結 | ✅ 正常 | URL 格式正確 |
| 備註 | 備註說明 | ✅ 正常 | 包含鉛筆圖示 |

## 🛠️ 技術調查需求

### 1. Google 表單欄位名稱確認
**需要檢查的項目：**
- [ ] 確認 Google 表單中每個欄位的完整名稱
- [ ] 檢查是否有空格、特殊字符或全形字符
- [ ] 確認欄位名稱與 Apps Script 程式碼中的對應關係
- [ ] 檢查條件性顯示欄位的實際名稱

**特別注意的欄位：**
- `是否收開瓶費？` - 可能包含問號或全形字符
- `開瓶費金額` - 條件性顯示欄位
- `其他：請說明` - 條件性顯示欄位
- `您的稱呼是？` - 可能包含問號

### 2. Google Apps Script 程式碼檢查
**需要檢查的函數和邏輯：**

#### 2.1 `parseSpreadsheetData` 函數
- [ ] 檢查 `headerMap` 建立邏輯
- [ ] 確認欄位名稱匹配是否正確
- [ ] 檢查條件性欄位的處理邏輯

#### 2.2 `toHalfWidth` 函數
- [ ] 確認全形字符轉換是否正確
- [ ] 檢查特殊字符處理
- [ ] 驗證空格處理

#### 2.3 欄位對應邏輯
- [ ] 檢查 `headerMap` 中的對應關係
- [ ] 確認資料提取邏輯
- [ ] 檢查空值處理

### 3. WordPress ACF 欄位檢查
**需要檢查的項目：**
- [ ] 確認 ACF 欄位名稱是否正確
- [ ] 檢查 `functions.php` 中的 `update_field` 函數
- [ ] 確認欄位類型設定
- [ ] 檢查欄位權限設定

### 4. 資料流程追蹤
**需要建立的除錯機制：**
- [ ] 在 Apps Script 中加入詳細的除錯日誌
- [ ] 記錄每個欄位的解析過程
- [ ] 記錄資料傳送到 WordPress 的內容
- [ ] 記錄 WordPress 接收到的資料

## 📊 測試計劃

### 階段 1：基礎檢查
1. **Google 表單欄位名稱確認**
   - 建立測試表單，填寫所有欄位
   - 記錄每個欄位的完整名稱
   - 檢查試算表中的實際資料

2. **Apps Script 除錯**
   - 在關鍵位置加入 `Logger.log()` 語句
   - 執行測試並檢查執行日誌
   - 記錄資料解析的每個步驟

### 階段 2：程式碼修正
1. **修正欄位對應邏輯**
   - 根據實際欄位名稱調整 `headerMap`
   - 修正條件性欄位的處理邏輯
   - 改善錯誤處理機制

2. **測試修正結果**
   - 重新提交測試表單
   - 檢查 Apps Script 執行日誌
   - 驗證 WordPress 文章建立結果

### 階段 3：完整驗證
1. **端到端測試**
   - 建立完整的測試案例
   - 測試所有欄位組合
   - 驗證邊界情況

2. **文件更新**
   - 更新欄位對應文件
   - 建立故障排除指南
   - 記錄解決方案

## 🔧 預期解決方案

### 可能的問題原因
1. **欄位名稱不匹配**
   - Google 表單欄位名稱與程式碼中的對應名稱不一致
   - 包含特殊字符或全形字符

2. **條件性欄位處理錯誤**
   - 條件性顯示的欄位沒有正確處理
   - 子層級欄位的邏輯錯誤

3. **資料格式問題**
   - 資料類型不匹配
   - 空值處理不當

4. **ACF 欄位設定問題**
   - ACF 欄位名稱不正確
   - 欄位類型設定錯誤

### 建議的修正步驟
1. **立即修正**
   - 檢查並修正 Apps Script 中的欄位對應
   - 加入詳細的除錯日誌
   - 測試基本功能

2. **中期改善**
   - 建立更穩健的錯誤處理機制
   - 改善資料驗證邏輯
   - 建立自動化測試

3. **長期優化**
   - 建立完整的監控系統
   - 改善用戶體驗
   - 建立備份機制

## 📝 相關檔案

### 需要檢查的檔案
- `Google Apps Script` - 主要程式碼檔案
- `functions.php` - WordPress 後端處理
- `ACF 欄位設定` - WordPress 後台設定
- `Google 表單設定` - 表單欄位配置

### 需要建立的檔案
- 除錯日誌檔案
- 欄位對應測試報告
- 故障排除指南
- 更新後的技術文件

## 🎯 成功標準

### 功能驗證
- [ ] 所有 Google 表單欄位都能正確對應到 WordPress ACF 欄位
- [ ] 條件性欄位能正確處理
- [ ] 複選欄位格式正確
- [ ] 空值處理適當

### 品質保證
- [ ] 建立完整的測試案例
- [ ] 建立除錯和監控機制
- [ ] 更新相關文件
- [ ] 建立故障排除流程

---

**備註：** 此問題需要優先處理，因為它影響到核心功能的正常運作。建議明天開始時立即進行詳細的技術調查和除錯工作。 