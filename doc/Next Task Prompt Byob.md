# 🍷 BYOB 專案工作規劃與進度追蹤

## 📅 當前日期：2025年8月26日

## 🚀 已完成任務


### ✅ 後端資料處理
- [x] 修改 `restaurant-member-functions.php` 處理新欄位
- [x] 修改 `functions.php` 的 `byob_create_restaurant_article` 函數
- [x] 修改 `functions.php` 的 `byob_create_restaurant_post` 函數
- [x] 新增 `restaurant_type_other_note` 欄位映射

### ✅ Google Apps Script 修改
- [x] 修改 `parseLatestSpreadsheetData` 函數
- [x] 新增「其他」餐廳類型的特殊處理邏輯
- [x] 從餐廳類型中提取說明文字的功能

### ✅ 開酒服務欄位問題解決
- [x] 修改 ACF 欄位選項：從 `yes:是, no:否, other:其他` 改為 `有, 無, 其他`
- [x] 修改 Google Apps Script：直接傳送 Google 表單值，無需轉換
- [x] 修改 WordPress functions.php：直接使用原始中文值
- [x] 修改餐廳編輯頁面：更新選項值和 JavaScript 邏輯

### ✅ 餐廳類型「其他」選項資料傳遞問題解決 ⭐ 已完成

**問題描述：**
Google 表單中的「其他」餐廳類型選項無法正確傳遞到 WordPress，導致餐廳資料編輯頁面無法顯示「其他」選項和說明文字。

**根本原因：**
Google 表單的「其他」選項機制與程式邏輯不匹配：
- Google 表單只傳送使用者輸入的文字（如「路上」），不會傳送「其他」選項本身
- Apps Script 無法識別「路上」是「其他」的說明文字
- 欄位設定表中保留 `restaurant_type_other_note` 映射，導致值被覆蓋

**解決方案：**
1. **實現「排除法」邏輯**：自動識別不在已知清單中的餐廳類型為「其他」說明
2. **修改 Apps Script**：使用 `continue` 避免無限迴圈，添加防護機制
3. **跳過欄位映射**：在主要映射循環中跳過 `restaurant_type_other_note` 的處理
4. **移除欄位設定表映射**：完全移除 `restaurant_type_other_note` 的映射行
5. **增強 WordPress 後端**：自動添加「其他」選項（如果有說明文字）

**修改的檔案：**
- `wordpress/Apps script - 純淨版.js`：實現「排除法」邏輯和防護機制
- `wordpress/functions.php`：增強餐廳類型處理邏輯
- `wordpress/woocommerce/myaccount/restaurant-profile.php`：正確顯示「其他」選項和說明文字
- Google 試算表欄位設定表：移除 `restaurant_type_other_note` 映射

**測試結果：** ✅ 成功解決，後台正確顯示「其他」選項和說明文字

### ✅ 餐廳資料編輯頁面下拉選單垂直對齊問題解決
- [x] 修正行政區下拉選單的垂直對齊問題
- [x] 修正開酒服務下拉選單的垂直對齊問題
- [x] 調整 inline CSS 樣式，確保選單文字垂直置中

### ✅ 「前往登入」按鈕樣式和連結修正
- [x] 將按鈕水平置中
- [x] 修改背景顏色為 `rgba(139, 38, 53, 0.8)`
- [x] 更新連結從 `https://byobmap.com/wp-login.php` 改為 `https://byobmap.com/my-account/`

### ✅ 開瓶費欄位分離和前台顯示修正 ⭐ 已完成
- [x] 成功分離開瓶費欄位為兩個 ACF 欄位：
  - `corkage_fee_amount`（開瓶費金額，數值類型）
  - `corkage_fee_note`（其他說明，單行文字類型）
- [x] 修改餐廳資料編輯頁面支援新的開瓶費欄位結構
- [x] 更新前台頁面（餐廳列表頁和單一餐廳頁）的開瓶費顯示邏輯
- [x] 修正中英文值比較問題，支援 "yes"/"no"/"other" 和 "酌收"/"不收費"/"其他"
- [x] 優化開瓶費顯示格式：
  - 當 `is_charged` = "yes" 時：開瓶費說明只顯示金額數字
  - 當 `is_charged` = "no" 時：開瓶費說明顯示「不收開瓶費」
  - 當 `is_charged` = "other" 時：開瓶費說明顯示自定義說明文字

## 🔴 待處理問題

### 🚨 優先級 1：餐廳直接加入頁面開發 ⭐ 明日重點處理

**需求描述：**
開發一個「餐廳直接加入」頁面，讓餐廳業者可以不透過 Google 表單，直接在網站上完成註冊並進入後台編輯餐廳資料。

**功能需求：**
1. **簡化註冊流程**：餐廳業者直接在網站上填寫基本資料
2. **即時註冊完成**：填寫完成後立即建立餐廳資料和業者帳號
3. **自動登入**：註冊完成後自動登入並跳轉到餐廳資料編輯頁面
4. **資料完整性**：確保所有必要欄位都有填寫

**技術實作要點：**
1. **前端表單設計**：建立美觀且易用的註冊表單
2. **後端處理邏輯**：整合現有的餐廳建立和用戶註冊功能
3. **資料驗證**：確保資料格式正確和完整性
4. **用戶體驗**：流暢的註冊和登入流程

**相關檔案：**
- 需要建立新的頁面模板
- 修改現有的餐廳建立邏輯
- 整合用戶註冊功能

### 🚨 優先級 2：Google Maps API 地址驗證功能 ⭐ 第二項工作

**需求描述：**
實作「Google Maps API + 前端即時驗證」的地址驗證組合，提升地址輸入的準確性和用戶體驗。

**功能需求：**
1. **前端即時驗證**：使用 Google Places Autocomplete 提供地址建議
2. **後端地址驗證**：使用 Google Geocoding API 驗證地址有效性
3. **地址標準化**：統一地址格式
4. **地圖預覽**：顯示地址在地圖上的位置

**技術實作要點：**
1. **Google Places Autocomplete**：前端即時地址建議
2. **Google Geocoding API**：後端地址驗證
3. **地址格式標準化**：統一地址顯示格式
4. **API 金鑰管理**：安全地管理 Google Maps API 金鑰
5. **成本控制**：設定 API 調用限制，避免超支

**實作步驟：**
1. 申請 Google Maps API 金鑰
2. 實作前端 Places Autocomplete
3. 實作後端 Geocoding API 驗證
4. 整合到餐廳註冊和編輯頁面
5. 測試和優化用戶體驗

**相關檔案：**
- 需要修改餐廳註冊表單
- 需要修改餐廳編輯頁面
- 需要新增 JavaScript 和 PHP 驗證邏輯

## 📋 明日工作清單

### 🔴 優先級 1：餐廳直接加入頁面開發 ⭐ 明日重點
- [ ] 分析現有的餐廳註冊流程和相關功能
- [ ] 設計新的餐廳直接加入頁面架構
- [ ] 建立前端註冊表單（包含所有必要欄位）
- [ ] 實作後端處理邏輯（整合餐廳建立和用戶註冊）
- [ ] 實作資料驗證和錯誤處理
- [ ] 實作自動登入和頁面跳轉功能
- [ ] 測試完整的註冊流程
- [ ] 優化用戶體驗和表單設計
- [ ] 整合到現有的導航和頁面結構

### 🟡 優先級 2：Google Maps API 地址驗證功能 ⭐ 第二項工作
- [ ] 申請和設定 Google Maps API 金鑰
- [ ] 實作前端 Google Places Autocomplete 功能
- [ ] 實作後端 Google Geocoding API 驗證
- [ ] 整合地址驗證到餐廳註冊表單
- [ ] 整合地址驗證到餐廳編輯頁面
- [ ] 實作地址格式標準化功能
- [ ] 設定 API 調用限制和成本控制
- [ ] 測試地址驗證的準確性和用戶體驗
- [ ] 優化地址建議和驗證流程

## 🎯 成功標準

### 餐廳直接加入頁面開發 ⭐ 明日重點
- [ ] 餐廳業者可以在網站上直接完成註冊，無需使用 Google 表單
- [ ] 註冊完成後自動建立餐廳資料和業者帳號
- [ ] 註冊完成後自動登入並跳轉到餐廳資料編輯頁面
- [ ] 所有必要欄位都有適當的驗證和錯誤處理
- [ ] 註冊流程順暢，用戶體驗良好
- [ ] 與現有系統完美整合，不影響現有功能

### Google Maps API 地址驗證功能 ⭐ 第二項工作
- [ ] 前端地址輸入提供即時建議和自動完成
- [ ] 後端地址驗證確保地址有效性和準確性
- [ ] 地址格式統一標準化，提升資料品質
- [ ] API 調用成本控制在合理範圍內
- [ ] 地址驗證功能整合到註冊和編輯頁面
- [ ] 用戶體驗流暢，減少地址輸入錯誤

## 📝 技術筆記

### 今日解決的關鍵技術點

**開瓶費欄位分離成功：**
1. **ACF 欄位分離**：成功將單一 `corkage_fee` 欄位分離為兩個專用欄位
2. **中英文值支援**：同時支援 "yes"/"no"/"other" 和 "酌收"/"不收費"/"其他"
3. **前台顯示優化**：根據不同選項顯示對應的資訊格式
4. **資料流程完整性**：從後台編輯到前台顯示的完整資料流程

**前台頁面修正：**
1. **變數重用問題**：修正重複獲取 `$is_charged` 變數導致的顯示錯誤
2. **條件判斷邏輯**：實現正確的開瓶費顯示邏輯
3. **用戶體驗優化**：簡化顯示格式，提升可讀性

**程式碼品質提升：**
1. **除錯功能**：新增管理員專用的除錯註解
2. **錯誤處理**：完善的條件判斷和錯誤處理邏輯
3. **程式碼一致性**：確保兩個前台頁面使用相同的邏輯

### 明日工作技術要點

**餐廳直接加入頁面開發：**
1. **現有功能整合**：利用現有的餐廳建立和用戶註冊功能
2. **表單設計**：建立美觀且功能完整的註冊表單
3. **資料驗證**：確保資料完整性和格式正確性
4. **用戶體驗**：流暢的註冊和登入流程

**Google Maps API 整合：**
1. **API 金鑰管理**：安全地管理 Google Maps API 金鑰
2. **前端整合**：使用 Google Places Autocomplete 提升用戶體驗
3. **後端驗證**：使用 Google Geocoding API 確保地址準確性
4. **成本控制**：設定合理的 API 調用限制

## 🔍 除錯資源

### 日誌檢查
- **WordPress**：`error_log` 中的 BYOB API 日誌
- **瀏覽器**：Console 中的 JavaScript 除錯資訊
- **管理員除錯**：前台頁面原始碼中的除錯註解

### 測試資料
- 使用簡單的測試資料驗證每個環節
- 檢查資料在每個環節的傳遞狀態
- 驗證最終儲存和顯示結果

### 參考文檔
- `doc/Google表單其他選項問題解決方案.md`：餐廳類型問題的詳細記錄
- `doc/開瓶費問題處理記錄.md`：開瓶費問題的詳細分析和處理記錄
- `wordpress/restaurant-member-functions.php`：餐廳會員系統功能
- `wordpress/functions.php`：核心功能函數