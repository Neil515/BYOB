# 🍷 BYOB 專案工作規劃與進度追蹤

## 📅 當前日期：2025年8月23日

## 🚀 已完成任務

### ✅ 餐廳資料編輯頁面欄位擴充
- [x] 新增「聯絡人姓名」欄位
- [x] 新增「行政區」下拉選單（台北市12區）
- [x] 新增「餐廳Email」欄位（與登入帳號同步）
- [x] 調整欄位順序和頁面結構
- [x] 修正「Fine dining」餐廳類型的大小寫問題

### ✅ 餐廳類型「其他」選項實作
- [x] 在餐廳類型中新增「其他」選項
- [x] 新增「其他類型說明」文字輸入欄位
- [x] 實作條件式顯示邏輯（選擇「其他」時顯示說明欄位）
- [x] 修改 JavaScript 控制邏輯
- [x] 更新 ACF 欄位設定

### ✅ 後端資料處理
- [x] 修改 `restaurant-member-functions.php` 處理新欄位
- [x] 修改 `functions.php` 的 `byob_create_restaurant_article` 函數
- [x] 修改 `functions.php` 的 `byob_create_restaurant_post` 函數
- [x] 新增 `restaurant_type_other_note` 欄位映射

### ✅ Google Apps Script 修改
- [x] 修改 `parseLatestSpreadsheetData` 函數
- [x] 新增「其他」餐廳類型的特殊處理邏輯
- [x] 從餐廳類型中提取說明文字的功能

### ✅ 開酒服務欄位問題解決
- [x] 修改 ACF 欄位選項：從 `yes:是, no:否, other:其他` 改為 `有, 無, 其他`
- [x] 修改 Google Apps Script：直接傳送 Google 表單值，無需轉換
- [x] 修改 WordPress functions.php：直接使用原始中文值
- [x] 修改餐廳編輯頁面：更新選項值和 JavaScript 邏輯

### ✅ 餐廳類型「其他」選項資料傳遞問題解決 ⭐ 今日重點完成

**問題描述：**
Google 表單中的「其他」餐廳類型選項無法正確傳遞到 WordPress，導致餐廳資料編輯頁面無法顯示「其他」選項和說明文字。

**根本原因：**
Google 表單的「其他」選項機制與程式邏輯不匹配：
- Google 表單只傳送使用者輸入的文字（如「路上」），不會傳送「其他」選項本身
- Apps Script 無法識別「路上」是「其他」的說明文字
- 欄位設定表中保留 `restaurant_type_other_note` 映射，導致值被覆蓋

**解決方案：**
1. **實現「排除法」邏輯**：自動識別不在已知清單中的餐廳類型為「其他」說明
2. **修改 Apps Script**：使用 `continue` 避免無限迴圈，添加防護機制
3. **跳過欄位映射**：在主要映射循環中跳過 `restaurant_type_other_note` 的處理
4. **移除欄位設定表映射**：完全移除 `restaurant_type_other_note` 的映射行
5. **增強 WordPress 後端**：自動添加「其他」選項（如果有說明文字）

**修改的檔案：**
- `wordpress/Apps script - 純淨版.js`：實現「排除法」邏輯和防護機制
- `wordpress/functions.php`：增強餐廳類型處理邏輯
- `wordpress/woocommerce/myaccount/restaurant-profile.php`：正確顯示「其他」選項和說明文字
- Google 試算表欄位設定表：移除 `restaurant_type_other_note` 映射

**測試結果：** ✅ 成功解決，後台正確顯示「其他」選項和說明文字

## 🔴 待處理問題

### 🚨 優先級 1：開酒服務欄位問題（與餐廳類型問題相同）

**問題描述：**
Google 表單的「是否提供開酒服務？」欄位，無論選擇哪個答案，同步到 ACF 後都顯示「是」。

**問題分析：**
與今天的餐廳類型問題完全一樣：
1. **Google 表單選項**：「有」、「無」、「其他」
2. **ACF 欄位選項**：已修改為「有」、「無」、「其他」
3. **問題所在**：需要比照餐廳類型的「排除法」邏輯處理

**解決方案：**
比照餐廳類型的處理方式：
1. **修改 Apps Script**：實現「排除法」識別未知的開酒服務類型
2. **跳過欄位映射**：如果 `open_bottle_service` 由特殊邏輯處理
3. **移除欄位設定表映射**：如果該欄位需要特殊處理

**相關檔案：**
- `wordpress/Apps script - 純淨版.js`
- Google 試算表欄位設定表

### 🚨 優先級 2：開瓶費金額顯示問題

**問題描述：**
開瓶費金額在後台餐廳編輯頁面無法正確顯示或編輯。

**待調查項目：**
1. 開瓶費金額欄位的資料傳遞流程
2. ACF 欄位設定和類型
3. 前端顯示和編輯功能
4. 資料儲存和讀取邏輯

### 🚨 優先級 3：後台餐廳編輯頁面美觀問題

**問題描述：**
後台餐廳編輯頁面的 UI/UX 需要改善，提升用戶體驗。

**待改善項目：**
1. 頁面佈局和間距
2. 欄位樣式和對齊
3. 按鈕設計和互動效果
4. 響應式設計
5. 整體視覺一致性

## 📋 明日工作清單

### 🔴 優先級 1：解決開酒服務欄位問題
- [ ] 分析開酒服務欄位的資料流程
- [ ] 比照餐廳類型「其他」的解決方案
- [ ] 修改 Google Apps Script 實現「排除法」邏輯
- [ ] 測試開酒服務欄位的資料傳遞
- [ ] 驗證 ACF 欄位正確顯示

### 🟡 優先級 2：解決開瓶費金額顯示問題
- [ ] 調查開瓶費金額欄位的問題根源
- [ ] 檢查 ACF 欄位設定和資料類型
- [ ] 檢查 Apps Script 的資料傳遞邏輯
- [ ] 檢查 WordPress 後端的處理邏輯
- [ ] 修復開瓶費金額的顯示和編輯功能

### 🟢 優先級 3：改善後台餐廳編輯頁面美觀
- [ ] 分析當前頁面的 UI/UX 問題
- [ ] 設計改善方案
- [ ] 修改 CSS 樣式和頁面佈局
- [ ] 優化欄位排列和間距
- [ ] 改善按鈕設計和互動效果

## 🎯 成功標準

### 開酒服務欄位問題解決
- [ ] Google 表單提交開酒服務選項時，資料正確傳遞
- [ ] WordPress 正確儲存開酒服務選項
- [ ] 餐廳資料編輯頁面正確顯示開酒服務選項
- [ ] 整個資料流程無錯誤

### 開瓶費金額問題解決
- [ ] 開瓶費金額正確顯示在編輯頁面
- [ ] 用戶可以正常編輯開瓶費金額
- [ ] 資料正確儲存和讀取

### 後台頁面美觀改善
- [ ] 頁面佈局更加合理和美觀
- [ ] 欄位排列整齊，間距適當
- [ ] 按鈕設計現代化，互動效果良好
- [ ] 整體視覺一致性提升

## 📝 技術筆記

### 今日解決的關鍵技術點

**「排除法」邏輯：**
1. **建立已知類型清單**：包含所有預定義的選項
2. **分析輸入資料**：分割並檢查每個選項
3. **識別未知類型**：不在清單中的類型歸類為「其他」說明
4. **自動處理邏輯**：根據情況自動添加「其他」選項

**防護機制：**
1. **重複處理檢查**：避免同一個欄位被處理多次
2. **使用 `continue` 而非 `return`**：避免無限迴圈
3. **強制檢查和設定**：確保重要值不會丟失

**欄位映射衝突避免：**
1. **跳過特殊處理欄位**：在主要映射循環中跳過
2. **移除設定表映射**：避免值被覆蓋
3. **邏輯分離**：特殊邏輯和一般映射分開處理

## 🔍 除錯資源

### 日誌檢查
- **Apps Script**：執行日誌中的除錯資訊
- **WordPress**：`error_log` 中的 BYOB API 日誌
- **瀏覽器**：Console 中的 JavaScript 除錯資訊

### 測試資料
- 使用簡單的測試資料驗證每個環節
- 檢查資料在每個環節的傳遞狀態
- 驗證最終儲存和顯示結果

### 參考文檔
- `doc/Google表單其他選項問題解決方案.md`：今日解決方案的詳細記錄