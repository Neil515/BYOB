# 🍷 BYOB 專案工作規劃與進度追蹤

## 📅 當前日期：2025年8月25日

## 🚀 已完成任務


### ✅ 後端資料處理
- [x] 修改 `restaurant-member-functions.php` 處理新欄位
- [x] 修改 `functions.php` 的 `byob_create_restaurant_article` 函數
- [x] 修改 `functions.php` 的 `byob_create_restaurant_post` 函數
- [x] 新增 `restaurant_type_other_note` 欄位映射

### ✅ Google Apps Script 修改
- [x] 修改 `parseLatestSpreadsheetData` 函數
- [x] 新增「其他」餐廳類型的特殊處理邏輯
- [x] 從餐廳類型中提取說明文字的功能

### ✅ 開酒服務欄位問題解決
- [x] 修改 ACF 欄位選項：從 `yes:是, no:否, other:其他` 改為 `有, 無, 其他`
- [x] 修改 Google Apps Script：直接傳送 Google 表單值，無需轉換
- [x] 修改 WordPress functions.php：直接使用原始中文值
- [x] 修改餐廳編輯頁面：更新選項值和 JavaScript 邏輯

### ✅ 餐廳類型「其他」選項資料傳遞問題解決 ⭐ 已完成

**問題描述：**
Google 表單中的「其他」餐廳類型選項無法正確傳遞到 WordPress，導致餐廳資料編輯頁面無法顯示「其他」選項和說明文字。

**根本原因：**
Google 表單的「其他」選項機制與程式邏輯不匹配：
- Google 表單只傳送使用者輸入的文字（如「路上」），不會傳送「其他」選項本身
- Apps Script 無法識別「路上」是「其他」的說明文字
- 欄位設定表中保留 `restaurant_type_other_note` 映射，導致值被覆蓋

**解決方案：**
1. **實現「排除法」邏輯**：自動識別不在已知清單中的餐廳類型為「其他」說明
2. **修改 Apps Script**：使用 `continue` 避免無限迴圈，添加防護機制
3. **跳過欄位映射**：在主要映射循環中跳過 `restaurant_type_other_note` 的處理
4. **移除欄位設定表映射**：完全移除 `restaurant_type_other_note` 的映射行
5. **增強 WordPress 後端**：自動添加「其他」選項（如果有說明文字）

**修改的檔案：**
- `wordpress/Apps script - 純淨版.js`：實現「排除法」邏輯和防護機制
- `wordpress/functions.php`：增強餐廳類型處理邏輯
- `wordpress/woocommerce/myaccount/restaurant-profile.php`：正確顯示「其他」選項和說明文字
- Google 試算表欄位設定表：移除 `restaurant_type_other_note` 映射

**測試結果：** ✅ 成功解決，後台正確顯示「其他」選項和說明文字

### ✅ 餐廳資料編輯頁面下拉選單垂直對齊問題解決
- [x] 修正行政區下拉選單的垂直對齊問題
- [x] 修正開酒服務下拉選單的垂直對齊問題
- [x] 調整 inline CSS 樣式，確保選單文字垂直置中

### ✅ 「前往登入」按鈕樣式和連結修正
- [x] 將按鈕水平置中
- [x] 修改背景顏色為 `rgba(139, 38, 53, 0.8)`
- [x] 更新連結從 `https://byobmap.com/wp-login.php` 改為 `https://byobmap.com/my-account/`

## 🔴 待處理問題

### 🚨 優先級 1：開瓶費「酌收」金額不顯示問題 ⭐ 明日重點處理

**問題描述：**
在 BYOB 餐廳平台的 Google 表單中，開瓶費欄位已經從單一的 `corkage_fee` 欄位改為兩個分離的 ACF 欄位：
1. **`corkage_fee_amount`**：開瓶費金額（數值類型）
2. **`corkage_fee_note`**：其他說明（單行文字類型）

但是，無論業者選擇「酌收」還是「其他」，這兩個 ACF 欄位都無法正確接收和儲存資料，顯示為空白。

**問題的具體表現：**

#### ❌ 「酌收」選項的問題
1. **Google 表單選擇**：業者選擇「酌收 (請按"繼續"填金額)」
2. **輸入金額**：業者在「開瓶費金額」欄位輸入「500」
3. **資料傳輸**：Apps Script 能正確接收到資料
4. **WordPress 儲存**：❌ 資料無法正確儲存到 ACF 欄位 `corkage_fee_amount`
5. **前台顯示**：❌ 金額完全不顯示，顯示為空白

#### ❌ 「其他」選項的問題
1. **Google 表單選擇**：業者選擇「其他 (請按"繼續"填補充說明)」
2. **輸入說明**：業者在「其他：請說明」欄位輸入「僅開紅酒」
3. **資料傳輸**：Apps Script 能正確接收到資料
4. **WordPress 儲存**：❌ 資料無法正確儲存到 ACF 欄位 `corkage_fee_note`
5. **前台顯示**：❌ 說明文字完全不顯示，顯示為空白

**問題的技術分析：**

#### 資料流程
```
Google 表單 → Apps Script → WordPress REST API → WordPress ACF → 前台頁面
```

#### 關鍵欄位（已更新）
- **`is_charged`**：開瓶費選項（酌收/不收費/其他）
- **`corkage_fee_amount`**：開瓶費金額（數值類型）
- **`corkage_fee_note`**：其他說明（單行文字類型）

#### 問題根源（已改變）
根據最新的測試結果，問題出現在：
1. **Apps Script 處理**：能正確識別「酌收」和「其他」選項
2. **WordPress 後端接收**：能正確接收到 `corkage_fee_amount` 和 `corkage_fee_note` 資料
3. **ACF 欄位儲存**：❌ 資料無法正確儲存到新的 ACF 欄位
4. **前台顯示**：❌ 兩個欄位都顯示為空白

**已實施的解決方案：**

#### 第一階段：新增 ACF 欄位 ✅ 已完成
1. **標籤：開瓶費金額，名稱：corkage_fee_amount，欄位類型：數值**
2. **標籤：其他：請說明，名稱：corkage_fee_note，欄位類型：單行文字**

#### 第二階段：修改 Google 試算表欄位設定表 ✅ 已完成
- `corkage_fee_amount` ← 「開瓶費金額」
- `corkage_fee_note` ← 「其他：請說明」

#### 第三階段：修改 Apps Script 邏輯 ✅ 已完成
- 實現條件邏輯，根據 `is_charged` 值設定對應的欄位
- 當選擇「酌收」時，設定 `corkage_fee_amount`
- 當選擇「其他」時，設定 `corkage_fee_note`

#### 第四階段：修改 WordPress 後端處理 ✅ 已完成
- 更新參數映射，新增 `corkage_fee_amount` 和 `corkage_fee_note`
- 更新資料轉換邏輯
- 修改 ACF 欄位更新，使用 `intval()` 處理數值欄位

#### 第五階段：測試驗證結果 ❌ 失敗
- 測試結果：兩個 ACF 欄位都無法正確儲存資料
- 執行日誌顯示：Apps Script 和 WordPress 後端都正確處理了資料
- 但 ACF 欄位仍然為空白

**當前狀態：**
- **餐廳類型問題**：✅ 已解決（資料類型保護）
- **開酒服務問題**：✅ 已解決（排除法邏輯）
- **開瓶費欄位分離**：✅ 已完成（兩個新 ACF 欄位）
- **開瓶費資料儲存**：❌ 失敗（兩個欄位都無法儲存）
- **開瓶費前台顯示**：❌ 失敗（兩個欄位都顯示空白）

**明日需要解決的具體問題：**
1. **確認 ACF 欄位設定**：檢查新的 ACF 欄位是否正確建立和分配
2. **檢查 WordPress 後端邏輯**：確認 ACF 欄位更新邏輯是否正確
3. **檢查資料類型問題**：確認數值欄位和文字欄位的處理是否正確
4. **檢查欄位權限**：確認 ACF 欄位是否有正確的權限設定
5. **測試驗證**：確保兩個欄位都能正確儲存和顯示

**關鍵技術點：**
- **ACF 欄位**：`corkage_fee_amount`（數值）、`corkage_fee_note`（文字）
- **Google 表單欄位**：「是否收開瓶費？」、「開瓶費金額」、「其他：請說明」
- **Apps Script 邏輯**：條件判斷和資料處理
- **WordPress 後端**：參數映射、資料轉換、ACF 欄位更新
- **資料類型處理**：數值欄位使用 `intval()`，文字欄位使用 `sanitize_text_field()`

**明日的工作重點：**
1. 檢查 ACF 欄位設定和分配
2. 檢查 WordPress 後端的 ACF 欄位更新邏輯
3. 檢查資料類型處理是否正確
4. 測試 ACF 欄位的手動編輯功能
5. 逐步除錯資料儲存流程

### 🚨 優先級 2：開酒服務欄位問題（與餐廳類型問題相同）

**問題描述：**
Google 表單的「是否提供開酒服務？」欄位，無論選擇哪個答案，同步到 ACF 後都顯示「是」。

**問題分析：**
與今天的餐廳類型問題完全一樣：
1. **Google 表單選項**：「有」、「無」、「其他」
2. **ACF 欄位選項**：已修改為「有」、「無」、「其他」
3. **問題所在**：需要比照餐廳類型的「排除法」邏輯處理

**解決方案：**
比照餐廳類型的處理方式：
1. **修改 Apps Script**：實現「排除法」識別未知的開酒服務類型
2. **跳過欄位映射**：如果 `open_bottle_service` 由特殊邏輯處理
3. **移除欄位設定表映射**：如果該欄位需要特殊處理

**相關檔案：**
- `wordpress/Apps script - 純淨版.js`
- Google 試算表欄位設定表

### 🚨 優先級 3：後台餐廳編輯頁面美觀問題

**問題描述：**
後台餐廳編輯頁面的 UI/UX 需要改善，提升用戶體驗。

**待改善項目：**
1. 頁面佈局和間距
2. 欄位樣式和對齊
3. 按鈕設計和互動效果
4. 響應式設計
5. 整體視覺一致性

## 📋 明日工作清單

### 🔴 優先級 1：解決開瓶費「酌收」金額不顯示問題 ⭐ 明日重點
- [ ] 檢查 ACF 欄位設定：確認 `corkage_fee_amount` 和 `corkage_fee_note` 是否正確建立
- [ ] 檢查 ACF 欄位分配：確認欄位是否分配給 `restaurant` 文章類型
- [ ] 檢查 WordPress 後端的 ACF 欄位更新邏輯：確認 `update_field()` 函數是否正確調用
- [ ] 檢查資料類型處理：確認數值欄位使用 `intval()`，文字欄位使用 `sanitize_text_field()`
- [ ] 測試 ACF 欄位的手動編輯功能：在後台手動編輯這兩個欄位，確認是否能正常儲存
- [ ] 檢查欄位權限：確認 ACF 欄位是否有正確的權限設定
- [ ] 逐步除錯資料儲存流程：從 WordPress 後端接收到 ACF 欄位更新的每個環節
- [ ] 測試「酌收」金額是否能正確儲存和顯示
- [ ] 測試「其他」說明是否能正確儲存和顯示

### 🟡 優先級 2：解決開酒服務欄位問題
- [ ] 分析開酒服務欄位的資料流程
- [ ] 比照餐廳類型「其他」的解決方案
- [ ] 修改 Google Apps Script 實現「排除法」邏輯
- [ ] 測試開酒服務欄位的資料傳遞
- [ ] 驗證 ACF 欄位正確顯示

### 🟢 優先級 3：改善後台餐廳編輯頁面美觀
- [ ] 分析當前頁面的 UI/UX 問題
- [ ] 設計改善方案
- [ ] 修改 CSS 樣式和頁面佈局
- [ ] 優化欄位排列和間距
- [ ] 改善按鈕設計和互動效果

## 🎯 成功標準

### 開酒服務欄位問題解決
- [ ] Google 表單提交開酒服務選項時，資料正確傳遞
- [ ] WordPress 正確儲存開酒服務選項
- [ ] 餐廳資料編輯頁面正確顯示開酒服務選項
- [ ] 整個資料流程無錯誤

### 開瓶費「酌收」金額問題解決 ⭐ 明日重點
- [ ] 當選擇「酌收」開瓶費時，金額能正確顯示在前台頁面
- [ ] 當選擇「其他」開瓶費時，說明文字仍然正常顯示
- [ ] 整個開瓶費資料流程無錯誤，資料正確儲存和讀取
- [ ] 解決欄位映射衝突問題，避免資料被覆蓋

### 後台頁面美觀改善
- [ ] 頁面佈局更加合理和美觀
- [ ] 欄位排列整齊，間距適當
- [ ] 按鈕設計現代化，互動效果良好
- [ ] 整體視覺一致性提升

## 📝 技術筆記

### 今日解決的關鍵技術點

**「排除法」邏輯：**
1. **建立已知類型清單**：包含所有預定義的選項
2. **分析輸入資料**：分割並檢查每個選項
3. **識別未知類型**：不在清單中的類型歸類為「其他」說明
4. **自動處理邏輯**：根據情況自動添加「其他」選項

**防護機制：**
1. **重複處理檢查**：避免同一個欄位被處理多次
2. **使用 `continue` 而非 `return`**：避免無限迴圈
3. **強制檢查和設定**：確保重要值不會丟失

**欄位映射衝突避免：**
1. **跳過特殊處理欄位**：在主要映射循環中跳過
2. **移除設定表映射**：避免值被覆蓋
3. **邏輯分離**：特殊邏輯和一般映射分開處理

### 開瓶費問題處理模式

**問題分析模式：**
1. **資料流程追蹤**：從 Google 表單到前台顯示的完整路徑
2. **欄位映射檢查**：確認每個欄位的來源和目標
3. **資料覆蓋分析**：識別可能的資料衝突點
4. **邏輯分離原則**：特殊處理邏輯與一般映射分開

**解決方案模式：**
1. **移除衝突映射**：在欄位設定表中移除有問題的映射
2. **Apps Script 特殊處理**：讓 Apps Script 完全控制特定欄位
3. **WordPress 後端驗證**：確保資料正確接收和儲存
4. **前台顯示測試**：驗證資料能正確顯示

**測試驗證模式：**
1. **快速重現問題**：使用簡單的測試資料
2. **逐步檢查流程**：每個環節的資料狀態
3. **對比測試**：正常情況與問題情況的對比
4. **完整流程驗證**：從表單提交到前台顯示

## 🔍 除錯資源

### 日誌檢查
- **Apps Script**：執行日誌中的除錯資訊
- **WordPress**：`error_log` 中的 BYOB API 日誌
- **瀏覽器**：Console 中的 JavaScript 除錯資訊

### 測試資料
- 使用簡單的測試資料驗證每個環節
- 檢查資料在每個環節的傳遞狀態
- 驗證最終儲存和顯示結果

### 參考文檔
- `doc/Google表單其他選項問題解決方案.md`：今日解決方案的詳細記錄
- `doc/開瓶費問題處理記錄.md`：開瓶費問題的詳細分析和處理記錄